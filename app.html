<script type="text/babel">

// данныe с сервера
var serverSideData = {};
// данные на фронте
var frontEndData = {
    timestamp: '',
    document: {},
    operation: '',
}
main();


function main() {
    google.script.run.withSuccessHandler(onSuccess).getServerData();
    function onSuccess (obj) {
        serverSideData = JSON.parse(obj);

        // данные для автокомплита
        serverSideData.docsPrettyIDs = {}
        getDocsPrettyID("ID", "ClientName", "docsSheet").forEach((elem) => {
            serverSideData.docsPrettyIDs[elem] = null
        });


        renderApp();
    };
};



// отправка одной строки функции на сервере, преобразующей ее в массив для записи
function storeData (data) {
    google.script.run.withSuccessHandler(onSuccess).storeData(JSON.stringify(data));
    function onSuccess () {
        alert("Данные записаны.")
    };
}


// один столбец данных исходя из его имени и имели листа
function getSingleCol(col, sheetName, withSpaces) {
    // col is text
    let result = [];
    let rawObj = serverSideData[sheetName];
    let colPosition = rawObj.headers.findIndex((el) => el === col);
    for (let key in serverSideData[sheetName]) {
        let elem = rawObj[key][colPosition];
        if (elem === '') {
            if(withSpaces === 'with_spaces') {
                result.push(elem)
            } else{
                continue;
            }
            
        } else {
         result.push(elem)
        }
    }    
    result.pop();
    return result;
}


function getSingleRowObj(row, sheetObj) {
    let result = {};
    let headers = sheetObj.headers;
    let docInArray = sheetObj[row];  
    headers.forEach(function (elem, index) {
        if (elem != '') {
            result[elem] = docInArray[index];
        }
    })
    return result;
}

function getRowNumber (ID, sheetObj) {
    let row;
    for (let key in sheetObj) {
        if (sheetObj[key][0] === ID) {
            return row = key;
        }
    }
    return row;
}


function getDocsPrettyID (firstCol, secondCol, sheetName) {
    let arrOne = getSingleCol(firstCol, sheetName, 'with_spaces');
    let arrTwo = getSingleCol(secondCol, sheetName, 'with_spaces');
    let result = arrOne.map((elem, index) => {
        return `${elem} ${arrTwo[index]}`;
    })
    return result;
}


// один столбец данных (квартиры) исходя из номера литера и имени листа 
function getFlatsInStock (forLiter, flatsCol, lirersCol, sheetName) {
    if (forLiter === '') {return null};
    let result = {};
    let twoCols = {
        flats: getSingleCol(flatsCol, sheetName),
        liters: getSingleCol(lirersCol, sheetName),
    }
    let flats = twoCols.flats;
    let liters = twoCols.liters;

    flats.forEach((elem, index) => {
        let flat = elem;
        let liter = liters[index];
        if (!Array.isArray(result[liter])) {
            result[liter] = [];
        } 
        result[liter].push(flat);
    });
    return result[forLiter];
}


function renderApp(prettyID) {
    ReactDOM.render(
    <App />,
        document.getElementById('root')
    );
}

class App extends React.Component {
    constructor (props) {
        super(props);
        this.handleHeaderClick = this.handleHeaderClick.bind(this);
        this.handleSaveBtn = this.handleSaveBtn.bind(this);
        this.handleDecision = this.handleDecision.bind(this);
        this.handleDocChange = this.handleDocChange.bind(this);
        this.handleCurrentDocClicked = this.handleCurrentDocClicked.bind(this)
        this.state = {
            timestamp: '',
            current_view: 'view_main',
            document: {},
            modal: false,
            transaction_in_process: false
        }
    };

    handleHeaderClick(field, changes) {
        this.setState({
            [field]: changes
        });
    };
    handleDocChange(field, value) {
        this.setState({
            [field]: value
        });
    };
    handleSaveBtn(e) {
        frontEndData.document = this.state.document;
        this.setState({
            modal: true,
        })
    }
    handleDecision(decision) {
        function saveData () {
            this.setState({
                transaction_in_process: true
            })
            storeData(this.state.document);
            this.setState({
                transaction_in_process: false,
                modal: false,
                current_view: 'view_main',
                document: {}
            })
        }
        if( decision === 'confirmed') {
            // сохранение данных в таблицу
            saveData.call(this);
        } else {
            this.setState({
                modal: false
            });
        }
    }
    
    handleCurrentDocClicked(docName) {
        let ID = docName.split(" ")[0];
        let position = getRowNumber(ID, serverSideData.docsSheet);
        let docDataObj = getSingleRowObj(position, serverSideData.docsSheet);

        this.setState({
            document: docDataObj,
            current_view: "edit_doc"
        })
    }
    render () {
        return (
            <React.Fragment>
                <header>
                    <Header 
                        logo="Виноград 2" 
                        docsList={serverSideData.docsPrettyIDs}
                        current_view={this.state.current_view}
                        onChange={this.handleHeaderClick}
                        onDocClicked={this.handleCurrentDocClicked}
                    />
                </header>
                <main>
                    <div className="container section">
                        {this.state.current_view === 'create_new_doc' &&
                        <div className="section row valign-wrapper">
                            <div className="col s10 offset-s1">
                                <h4 className="indigo-text text-darken-4">
                                    Новый документ
                                </h4>
                            </div> 
                        </div>
                        }
                        {/* поля сделки и кнопка сохранения */}
                        {(this.state.current_view === 'create_new_doc' || this.state.current_view === 'edit_doc')&&
                        <React.Fragment>
                            <DocFieldsHandler 
                            onFieldChange={this.handleDocChange}
                            onSaveButton={this.handleSaveBtn}
                            currentDocument={this.state.document}
                            current_view={this.state.current_view}
                            />
                        </React.Fragment>
                        }
                        {/* модальное окно */}
                        {this.state.modal &&
                            <Modal 
                                id="comfirmation"
                                onDecision={this.handleDecision}
                            />
                        }    
                    </div>
                </main>
            </React.Fragment>
        );
    };
};
</script>