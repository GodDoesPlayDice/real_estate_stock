<script type="text/babel">
// запуск приложения при загрузке страницы
main();

function main() {
    google.script.run.withSuccessHandler(onSuccess).getServerData();

    function onSuccess (obj) {
        serverSideData = JSON.parse(obj);
        renderApp();
        //console.log(getFlatsInStock(7, 'flats_in_sale', 'flats_in_sale_liter', "utilitySheet"));
    };
};

// данныe с сервера
var serverSideData = {};

// выдает массив с айдишниками документов

function getSingleCol(col, sheetName) {
    // col is text
    let result = [];
    let rawObj = serverSideData[sheetName];
    let colPosition = rawObj.headers.findIndex((el) => el === col);
    for (let key in serverSideData[sheetName]) {
        let elem = rawObj[key][colPosition];
        if (elem === '') {
            continue;
        } else {
         result.push(elem)
        }
    }    
    result.pop();
    return result;
}

function getFlatsInStock (forLiter, flatsCol, lirersCol, sheetName) {
    if (forLiter == '') {return null};
    let result = {};
    let twoCols = {
        flats: getSingleCol(flatsCol, sheetName),
        liters: getSingleCol(lirersCol, sheetName),
    }
    let flats = twoCols.flats;
    let liters = twoCols.liters;
    
    flats.forEach((elem, index) => {
        let flat = elem;
        let liter = liters[index];
        if (!Array.isArray(result[liter])) {
            result[liter] = [];
        } 
        result[liter].push(flat);
    });
    return result[forLiter];
}

function materialUpdateSelect (id) {
    var elem = document.getElementById(id);
    var instance = M.FormSelect.getInstance(elem);
    instance.destroy();
    var elemNew = document.getElementById(id);
    M.FormSelect.init([elemNew], {});
}


function renderApp() {
    ReactDOM.render(
    <App />,
        document.getElementById('root')
    );
}
</script>