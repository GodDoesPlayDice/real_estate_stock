<script type="text/babel">
// запуск приложения при загрузке страницы
main();

function main() {
    google.script.run.withSuccessHandler(onSuccess).getServerData();

    function onSuccess (obj) {
        serverSideData = JSON.parse(obj);
        renderApp();
        //console.log(getFlatsInStock(7, 'flats_in_sale', 'flats_in_sale_liter', "utilitySheet"));
    };
};

// данныe с сервера
var serverSideData = {};

// выдает массив с айдишниками документов

function getSingleCol(col, sheetName) {
    // col is text
    let result = [];
    let rawObj = serverSideData[sheetName];
    let colPosition = rawObj.headers.findIndex((el) => el === col);
    for (let key in serverSideData[sheetName]) {
        let elem = rawObj[key][colPosition];
        if (elem === '') {
            continue;
        } else {
         result.push(elem)
        }
    }    
    result.pop();
    return result;
}

function getFlatsInStock (forLiter, flatsCol, lirersCol, sheetName) {
    if (forLiter === '') {return null};
    let result = {};
    let twoCols = {
        flats: getSingleCol(flatsCol, sheetName),
        liters: getSingleCol(lirersCol, sheetName),
    }
    let flats = twoCols.flats;
    let liters = twoCols.liters;
    
    flats.forEach((elem, index) => {
        let flat = elem;
        let liter = liters[index];
        if (!Array.isArray(result[liter])) {
            result[liter] = [];
        } 
        result[liter].push(flat);
    });
    //console.log(result[forLiter], "массив рассчитан, проблема где-то дальше")
    return result[forLiter];
}

let frontEndData = {
    timestamp: '',
    document: {},
    operation: '',
}

function storeData () {
    google.script.run.withSuccessHandler(onSuccess).storeData(JSON.stringify(frontEndData.document));

    function onSuccess (obj) {
        alert("Спасибо за информацию. Иди работать!")
        //console.log(getFlatsInStock(7, 'flats_in_sale', 'flats_in_sale_liter', "utilitySheet"));
    };
}

class App extends React.Component {
    constructor (props) {
        super(props);
        this.handleChange = this.handleChange.bind(this);
        this.handleSaveBtn = this.handleSaveBtn.bind(this);
        this.handleDecision = this.handleDecision.bind(this);
        this.state = {
            timestamp: '',
            current_view: 'view_main',
            document: {},
            modal: false,
            transaction_in_process: false

        }
    };
    handleChange(field, changes) {
        this.setState({
            [field]: changes
        });
    };
    //  отправка данных на сервер 
    handleSaveBtn(e) {
        frontEndData.document = this.state.document;
        console.log(this.state.document)
        this.setState({
            modal: true,
        })
    }
    handleDecision(decision) {
        
        async function saveData () {
            this.setState({
                transaction_in_process: true
            })
            let promise = storeData();
            await promise;
            this.setState({
                transaction_in_process: false,
                modal: false
            })
        }
        if( decision === 'confirmed') {
            saveData.call(this);
        } else {
            this.setState({
                modal: false
            });
        }
        
    }
    
    render () {
        // создание объекта для поиска сделок в автокомплите
        let docNamesObj = {};
        getSingleCol("ID", "docsSheet").forEach((elem) => {
            docNamesObj[elem] = null
        });
        //
        return (
            <div>
                <Header 
                    logo="Виноград 2" 
                    docsList={docNamesObj}
                    current_view={this.state.current_view}
                    onChange={this.handleChange}
                />
                <div class="container row">
                    {/* поля сделки и кнопка сохранения */}
                    {this.state.current_view === 'create_new_doc' &&
                    <React.Fragment>
                        <DocFieldsHandler 
                        onChange={this.handleChange}
                        />
                        <a class="waves-effect waves-light btn-large" onClick={this.handleSaveBtn}><i class="material-icons left">save</i>Сохранить</a>
                    </React.Fragment>
                    } 
                    {/* модальное окно */}
                    {this.state.modal &&
                        <Modal 
                            id="comfirmation"
                            onDecision={this.handleDecision}
                        />
                    }    
                </div>
            </div>
        );
    };
};

function renderApp() {
    ReactDOM.render(
    <App />,
        document.getElementById('root')
    );
}
</script>