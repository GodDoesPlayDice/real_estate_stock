<script>
    
</script>

<script type="text/babel">

// данныe с сервера
var serverSideData = {
    docsPrettyIDs: {},
    statusesForDocs: {},
    features: {
        statuses: false,
        edit: false,
        verify: false,
        delete: false,
    }
};
main();

function main() {
    google.script.run.withSuccessHandler(onSuccess).getServerData();
    function onSuccess (obj) {
        serverSideData = JSON.parse(obj);
        /* в основном объекте с данными создаем ключ для списка документов для автокомплита */
        serverSideData.docsPrettyIDs = {};
        /* актуальный список сделок для автокомплита из массива превращается в объект */
        getDocsPrettyID("ID", "ClientName", "docsSheet").forEach((elem) => {
            serverSideData.docsPrettyIDs[elem] = null
        });
        /* актуальные данные по статусам документов для просмотра */
        serverSideData.statusesForDocs = getStatusesForDocs("DocStatus", "ID", "ClientName", "ActualCost", "docsSheet");

        /* рендерим приложение заново с новыми данными */
        renderApp(false);
    };
};

// отправка одной строки функции на сервере, преобразующей ее в массив для записи
function storeData (data) {
    renderApp(true, "Сохранение данных...");
    google.script.run.withSuccessHandler(onSuccess).storeData(JSON.stringify(data));
    function onSuccess () {
        renderApp(true, "Загрузка последних данных...");
        main();
    };
}

function archive(ID) {
    renderApp(true, "Удаление документа: " + ID);
    google.script.run.withSuccessHandler(onSuccess).archive(ID);
    function onSuccess () {
        renderApp(true, "Загрузка последних данных...");
        main();
    };
}


function renderApp(preloaderStatus, preloaderMessage) {
    ReactDOM.render(
        <App 
            preloaderStatus={preloaderStatus}
            preloaderMessage={preloaderMessage}
        />,
        document.getElementById('root')
    );
}




class App extends React.Component {
    constructor (props) {
        super(props);
        this.handleHeaderClick = this.handleHeaderClick.bind(this);
        this.handleSaveBtn = this.handleSaveBtn.bind(this);
        this.handleModalDecision = this.handleModalDecision.bind(this);
        this.handleDocChange = this.handleDocChange.bind(this);
        this.handleCurrentDocClicked = this.handleCurrentDocClicked.bind(this)
        this.handleArchiveBtn = this.handleArchiveBtn.bind(this);
        this.state = {
            timestamp: '',
            current_view: 'view_main',
            document: {},
            modal: false,
            modalConfirmButtonPurpose: '',
            modalHeader: '',
            modalBody: '',
            docIDforArchive: ''
        }
    };

    handleHeaderClick(field, changes) {
        this.setState({
            current_view: "view_main",
            document: {}
        });
        setTimeout(()=>{
            this.setState({
                [field]: changes
            });
        },30)
    };
    handleCurrentDocClicked(prettyID) {
        let ID = prettyID.split(" ")[0];
        let position = getRowNumber(ID, serverSideData.docsSheet);
        let docDataObj = getSingleRowObj(position, "docsSheet");

        this.setState({
            current_view: "view_main",
            document: {}
        });
        setTimeout(()=>{
            this.setState({
                current_view: "edit_doc",
                document: docDataObj,
            });
        },30)

    }
    handleDocChange(field, value) {
        this.setState({
            [field]: value
        });
    };
    handleSaveBtn(e) {
        this.setState({
            modalConfirmButtonPurpose: 'save',
            modalHeader: "Сохранить документ",
        })
        setTimeout(() => {
            this.setState({
                modalBody: `${this.state.document.SelectLiter}/${this.state.document.SelectFlat} ${this.state.document.ClientName}`,
                modal: true,
            })
        }, 30)
    }
    
    handleArchiveBtn (ID) {
        this.setState({
            modalConfirmButtonPurpose: 'archive',
            modalHeader: "Удалить документ и овободить квартиру",
            modalBody: `${ID}`,
            docIDforArchive: ID
        })
        setTimeout(()=>{
            this.setState({
                modal: true,
            });
        },30)
    } 
    handleModalDecision(decision) {
        switch (decision) {
            case 'save':
                storeData(this.state.document);

                this.setState({
                    modal: false,
                    current_view: 'view_main',
                    document: {},
                });
                break;
            case 'archive':
                archive(this.state.docIDforArchive);
                this.setState({
                    modal: false,
                    current_view: 'view_main',
                    document: {},
                });
                break;
            default:
                this.setState({
                    modal: false
                });
        }
    }
    
    render () {
        return (
            <React.Fragment>
                <header id='header'>
                    <Header 
                        logo={serverSideData.departmentName}
                        docsList={serverSideData.docsPrettyIDs}
                        current_view={this.state.current_view}
                        onButtonsClicked={this.handleHeaderClick}
                        onDocClicked={this.handleCurrentDocClicked}
                    />
                </header>
                <main>
                    <div className="container section">
                        <div className="section row valign-wrapper">
                            <div className="col s10 offset-s1">
                                <h4 className="indigo-text text-darken-4">
                                    {/* влияние состояния на заголовок в рабочей области */}
                                    {this.state.current_view === 'create_new_doc' &&
                                    "Новый документ"
                                    }
                                    {this.state.current_view === 'edit_doc' &&
                                    `Редактирование документа. Квартира - ${this.state.document.ID}`}
                                    {this.state.current_view === 'view_main' &&
                                    `Статусы документов`}
                                </h4>
                            </div> 
                        </div>
                        {/* поля сделки и кнопка сохранения */}
                        {(this.state.current_view === 'create_new_doc' || this.state.current_view === 'edit_doc')&&
                        <React.Fragment>
                            <OasisDocFieldsHandler 
                            onFieldChange={this.handleDocChange}
                            onSaveButton={this.handleSaveBtn}
                            currentDocument={this.state.document}
                            current_view={this.state.current_view}
                            />
                        </React.Fragment>
                        }
                        {/* основной экран со статусами документов */}
                        {this.state.current_view === 'view_main' &&
                            <CurrentDocs
                            id="collapsible"
                            dataObj={serverSideData.statusesForDocs}
                            handleArchiveBtn={this.handleArchiveBtn}
                            handleEditBtn={this.handleCurrentDocClicked}
                            />
                        }
                        {/* модальное окно */}
                        {this.state.modal &&
                            <Modal 
                                id="comfirmation_modal"
                                header={this.state.modalHeader}
                                body={this.state.modalBody}
                                onDecision={this.handleModalDecision}
                                confirmButtonPurpose={this.state.modalConfirmButtonPurpose}
                            />
                        }  
                        {this.props.preloaderStatus === true &&
                            <PreloaderModal 
                                id="preloader"
                                message={this.props.preloaderMessage}
                            />
                        }   
                    </div>
                </main>
            </React.Fragment>
        );
    };
};
</script>