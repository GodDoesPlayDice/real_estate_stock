<script type="text/babel">
class TextField extends React.Component {
    constructor (props) {
        super(props);
        this.handleChange = this.handleChange.bind(this);
        this.state = {value: ''}
    }
    componentDidMount(){
        let elem = document.getElementById(this.props.id);
        elem.addEventListener('focusout', (e) => {
            this.props.onChange(this.props.id, this.state.value);
        });
        M.updateTextFields();
    }
    handleChange(e) {
        this.setState({
            value: e.target.value
        })
    }
    render() {
        let element;
        switch (this.props.purpose) {
            case "area":
                element = <textarea id={this.props.id} key={this.props.id} value={this.state.value} className="materialize-textarea" onChange={this.handleChange}></textarea>;
                break;
            default:
                element = <input id={this.props.id} key={this.props.id} value={this.state.value} type="text" className="validate" onChange={this.handleChange} />
        }
        return (
            <div className="row">
                    <div className="input-field col s10 offset-s1">
                        {element}
                        <label htmlFor={this.props.id} >{this.props.label}</label>
                    </div>
            </div>
        )
    }
}

class DatePicker extends React.Component {
    constructor(props) {
        super(props);
        this.handleChange = this.handleChange.bind(this);
    }
    componentDidMount() {
        let options = {
                format: "dd/mm/yyyy",
                firstDay: 1,
                i18n: {
                        cancel: "Отмена",
                        clear: "Очистить",
                        done: "Готово",
                            months: ['Январь',
                                'Февраль',
                                'Март',
                                'Апрель',
                                'Май',
                                'Июнь',
                                'Июль',
                                'Август',
                                'Сентябрь',
                                'Октябрь',
                                'Ноябрь',
                                'Декабрь'
                        ],
                            monthsShort: [
                                'Янв',
                                'Фев',
                                'Мар',
                                'Апр',
                                'Май',
                                'Июн',
                                'Июл',
                                'Авг',
                                'Сен',
                                'Окт',
                                'Ноя',
                                'Дек'
                        ],
                            weekdays: [
                                'Воскресенье',
                                'Понедельник',
                                'Вторник',
                                'Среда',
                                'Четверг',
                                'Пятница',
                                'Суббота'
                        ],
                            weekdaysShort: [
                                'Вос',
                                'Пон',
                                'Вт',
                                'Ср',
                                'Чет',
                                'Пят',
                                'Суб'
                        ],
                            weekdaysAbbrev: ['В', 'П', 'В', 'С', 'Ч', 'П', 'С']
                    }
                }
        let elem = document.getElementById(this.props.id);
        let instance = M.Datepicker.init(elem, options);
        elem.addEventListener('change', (e) => {
            this.props.onChange(this.props.id, e.target.value)
        });
    }
    componentWillUnmount() {
        let elem = document.getElementById(this.props.id);
        let instance = M.Datepicker.init(elem, {});
        instance.destroy();
    }
    handleChange(e) {
    };
    render() {
        return (
            <div className="row">
                <div className="input-field col s10 offset-s1">
                    <input id={this.props.id} key={this.props.id} type="text" className="datepicker"  />
                    <label htmlFor={this.props.id}>{this.props.label}
                    </label>
                </div>
            </div>
        )
    }
};

class Radio extends React.Component {
    constructor (props) {
        super(props);
        this.handleChange = this.handleChange.bind(this);
        this.state = ({
            span1: 'normal',
            span2: 'normal'
        })
    }
    handleChange(e) {
        this.props.onChange(this.props.id, e.target.value);
        this.setState({
            span1: e.target.value === this.props.first ? "bolder" : "normal",
            span2: e.target.value === this.props.second ? "bolder" : "normal",
        });
    }
    render() {
        return (
            <div className="row">
                <div className="col s10 offset-s1">
                <label>{this.props.label}</label>
                    <form key={this.props.id}>
                        <p>
                        <label>
                            <input name="group1" type="radio" value={this.props.first} onClick={this.handleChange} />
                            <span style={{"fontWeight": this.state.span1}} >{this.props.first}</span>
                        </label>
                        </p>
                        <p>
                        <label>
                            <input name="group1" type="radio" value={this.props.second} onClick={this.handleChange} />
                            <span style={{"fontWeight": this.state.span2}} >{this.props.second}</span>
                        </label>
                        </p>
                    </form>
                </div>
            </div>
        )
    }
};

class CheckBox extends React.Component {
    constructor (props) {
        super(props);
        this.handleChange = this.handleChange.bind(this);
        this.state = ({
            span: "normal"
        })
    }
    componentDidMount() {
    }
    handleChange(e) {
        this.props.onChange(this.props.id, !this.props.value);
        this.setState({
            span:  (!this.props.value ? "bolder" : "normal")
        });
    }
    render() {
        return (
            <div className="row">
                <div className="col s10 offset-s1">
                    <p>
                        <label>
                            <input id={this.props.id} key={this.props.id} type="checkbox"  className="filled-in" checked={this.props.value ? "checked" : ""} value={this.props.value} onChange={this.handleChange} />
                            <span style={{"fontWeight": this.state.span}} >{this.props.label}</span>
                        </label>
                    </p>
                </div>
            </div>
        )
    }
}

class Select extends React.Component {
    constructor (props) {
        super(props);
        this.handleChange = this.handleChange.bind(this);
    };
    componentDidMount(){
        let elem = document.getElementById(this.props.id);
        let instance = M.FormSelect.init(elem, {});
    };
    componentWillUnmount(){
    }
    handleChange(e) {
        let val = e.target.value;
        {this.props.id === "SelectLiter" &&  this.props.onChange(this.props.id, '');}
        setTimeout(() => {
        this.props.onChange(this.props.id, val);
        }, 10)
        
    }
    render () {
        function generateOptions (arr) {
            if (arr != null) {
                return arr.map((el) =>
                    <option key={el} value={el}>{el}</option>
                );
            } else {
                return <option value=""></option>
            } 
        };
        let options = generateOptions(this.props.value); 
        let specialClass;
        if (this.props.purpose === "flat") {
            //specialClass = "browser-default";
        } 
        return (
            <div className="row">
                <div className="input-field col s10 offset-s1">
                    {<select className={specialClass} key={this.props.id} id={this.props.id} onChange={this.handleChange} >
                        <option value=""></option>
                        {options}
                    </select>}
                    <label htmlFor={this.props.id}>{this.props.label}</label>
                </div>
            </div>
        );
    };
};

class DocFieldsHandler extends React.Component {
    constructor (props) {
        super(props);
        this.handleChildChange = this.handleChildChange.bind(this);
        this.handleSaveBtn = this.handleSaveBtn.bind(this);
        this.state = {
            CurrentStatusDate: '',
            NextStatusEstimatedDate: '',
            ClientName: '',
            RemainsOnSale: false,
            DealType: '',
            SelectLiter: '',
            SelectFlat: '',
            DocStatus: '',
            SelectManager: '',
            PayMethod: '',
            ActualCost: '',
            LegalCost: '',
            LegalServiceCost: '',
            LegalServiceNoPayment: '',
            RealEstateAgency: '',
            EstateAgent: '',
            Comment: ''
        };
    };
    // принимает изменения от всех полей 
    handleChildChange(field, value) {
/*         {field === 'SelectLiter' &&
        this.setState({
            'SelectLiter': '',
        });
        } */
        this.setState({
            [field]: value,
        });
    };
    handleSaveBtn () {
        this.props.onFieldChange("document", this.state);
        this.props.onSaveButton();
    }

    render () {
        return (
            <React.Fragment>
                <div className="row dp_sec">
                    <div className="col s10 offset-s1 card-panel deep-purple lighten-5">
                        <div className="section"></div>
                            <Select
                                id = "DocStatus"
                                label = "Текущий статус документа:"
                                value = {getSingleCol("doc_statuses", "utilitySheet")}
                                onChange={this.handleChildChange}
                            />
                            <DatePicker
                                id = "CurrentStatusDate"
                                label = "Дата текущего статуса:"
                                value = {this.state.CurrentStatusDate}
                                onChange={this.handleChildChange}
                            />
                            <DatePicker
                                id = "NextStatusEstimatedDate"
                                label = "Предполагаемая дата следующего статуса:"
                                value = {this.state.NextStatusEstimatedDate}
                                onChange={this.handleChildChange}
                            />
                        <div className="section"></div>
                    </div>
                </div>
                <div className="row i_sec">
                    <div className="col s10 offset-s1 card-panel indigo lighten-5">
                        <div className="section"></div>
                            <Select
                                id = "SelectLiter"
                                label = "Литер:"
                                value = {getSingleCol("liters", "utilitySheet")}
                                onChange={this.handleChildChange}
                            />{this.state.SelectLiter != '' &&
                            <Select
                                id = "SelectFlat"
                                label = "Номер квартиры:"
                                value = {getFlatsInStock(this.state.SelectLiter,'flats_in_sale', 'flats_in_sale_liter', "utilitySheet")}
                                purpose = "flat"
                                onChange={this.handleChildChange}
                            />
                            }
                            <TextField
                                id = "ClientName"
                                label = "ФИО клиента:"
                                value = {this.state.ClientName}
                                onChange={this.handleChildChange}
                            />
                        <div className="section"></div>
                    </div>
                </div>
                <div className="row dp_sec">
                    <div className="col s10 offset-s1 card-panel deep-purple lighten-5">
                        <div className="section"></div>
                            <Select
                                id = "SelectManager"
                                label = "Менеджер:"
                                value = {getSingleCol("managers", "utilitySheet")}
                                onChange={this.handleChildChange}
                            />
                            <CheckBox
                                id = "RemainsOnSale"
                                label = "остается в продаже от физ. лица"
                                value = {this.state.RemainsOnSale}
                                onChange={this.handleChildChange}
                            />
                            <Radio
                                id = "DealType"
                                label = "Тип сделки:"
                                first='Л'
                                second='АН'
                                value = {this.state.DealType}
                                onChange={this.handleChildChange}
                            />
                        <div className="section"></div>
                    </div>
                </div>                                                              
                <div className="row i_sec">
                    <div className="col s10 offset-s1 card-panel indigo lighten-5">
                        <div className="section"></div>
                            <Select
                                id = "PayMethod"
                                label = "Способ оплаты:"
                                value = {getSingleCol("pay_method", "utilitySheet")}
                                onChange={this.handleChildChange}
                            />
                            <TextField
                                id = "ActualCost"
                                label = "Стоимость для расчета комиссии:"
                                value = {this.state.ActualCost}
                                onChange={this.handleChildChange}
                            />
                            <TextField
                                id = "LegalCost"
                                label = "Стоимость по ДДУ:"
                                value = {this.state.LegalCost}
                                onChange={this.handleChildChange}
                            />
                            {this.state.LegalServiceNoPayment === '' &&
                            <TextField
                                id = "LegalServiceCost"
                                label = "Оплата юр. услуг:"
                                value = {this.state.LegalServiceCost}
                                onChange={this.handleChildChange}
                            />
                            }
                            {this.state.LegalServiceCost === '' &&
                            <Select
                                id = "LegalServiceNoPayment"
                                label = "Юр. услуги без оплаты:"
                                value = {getSingleCol("legal_service_no_payment", "utilitySheet")}
                                onChange={this.handleChildChange}
                            />
                            }
                        <div className="section"></div>
                    </div>
                </div>
                {this.state.DealType === 'АН' &&
                <div className="row dp_sec">
                    <div className="col s10 offset-s1 card-panel deep-purple lighten-5">
                        <div className="section"></div>
                            <React.Fragment>
                            <TextField
                                id = "RealEstateAgency"
                                label = "Агентство недвижимости:"
                                value = {this.state.RealEstateAgency}
                                onChange={this.handleChildChange}
                            />
                            <TextField
                                id = "EstateAgent"
                                label = "Сотрудник агентства:"
                                value = {this.state.EstateAgent}
                                onChange={this.handleChildChange}
                            />
                            </React.Fragment>
                            
                        <div className="section"></div>
                    </div>
                </div>
                }
                <div className="row i_sec">
                    <div className="col s10 offset-s1 card-panel indigo lighten-5">
                        <div className="section"></div>
                            <TextField
                                id = "Comment"
                                label = "Комментарий к документу:"
                                purpose = "area"
                                value = {this.state.Comment}
                                onChange={this.handleChildChange}
                            />
                        <div className="section"></div>
                    </div>
                </div>
                <div className="section">
                <div className="section row">
                        <a className="waves-effect waves-light btn-large col s6 offset-s3 deep-purple lighten-3" 
                        onClick={this.handleSaveBtn}>Сохранить</a>
                    </div>
                </div>
            </React.Fragment>
        )
    }
};
</script>