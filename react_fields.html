<script type="text/babel">
class TextField extends React.Component {
    constructor (props) {
        super(props);
        this.label = this.props.label;
        this.id = this.props.id;
        this.key = this.props.key;
        this.handleChange = this.handleChange.bind(this);
        this.value = this.props.value;
        this.purpose = this.props.purpose;
        this.state = {value: this.value}
    }
    componentDidMount(){
        let elem = document.getElementById(this.id);
        elem.addEventListener('focusout', (e) => {
            this.props.onChange(this.id, e.target.value);
        });
        M.updateTextFields();
    }
    handleChange(e) {
        this.setState({value: e.target.value});
    }
    render() {
        let element;
        switch (this.purpose) {
            case "area":
                element = <textarea id={this.id} key={this.key} value={this.state.value} class="materialize-textarea" onChange={this.handleChange}></textarea>;
                break;
            default:
                element = <input id={this.id} key={this.key} value={this.state.value} type="text" class="validate" onChange={this.handleChange} />
        }
        return (
            <form class="col s12">
                <div class="row">
                    <div class="input-field col s6">
                        {element}
                        <label for="" >{this.label}</label>
                    </div>
                </div>
            </form>
        )
    }
}

class DatePicker extends React.Component {
    constructor(props) {
        super(props);
        this.label = this.props.label;
        this.id = this.props.id;
        this.key = this.props.key
        this.handleChange = this.handleChange.bind(this);
        this.value = this.props.value;
    }
    componentDidMount() {
        let options = {
                format: "dd/mm/yyyy",
                firstDay: 1,
                i18n: {
                        cancel: "Отмена",
                        clear: "Очистить",
                        done: "Готово",
                            months: ['Январь',
                                'Февраль',
                                'Март',
                                'Апрель',
                                'Май',
                                'Июнь',
                                'Июль',
                                'Август',
                                'Сентябрь',
                                'Октябрь',
                                'Ноябрь',
                                'Декабрь'
                        ],
                            monthsShort: [
                                'Янв',
                                'Фев',
                                'Мар',
                                'Апр',
                                'Май',
                                'Июн',
                                'Июл',
                                'Авг',
                                'Сен',
                                'Окт',
                                'Ноя',
                                'Дек'
                        ],
                            weekdays: [
                                'Воскресенье',
                                'Понедельник',
                                'Вторник',
                                'Среда',
                                'Четверг',
                                'Пятница',
                                'Суббота'
                        ],
                            weekdaysShort: [
                                'Вос',
                                'Пон',
                                'Вт',
                                'Ср',
                                'Чет',
                                'Пят',
                                'Суб'
                        ],
                            weekdaysAbbrev: ['В', 'П', 'В', 'С', 'Ч', 'П', 'С']
                    }
                }
        let elem = document.getElementById(this.id);
        let instance = M.Datepicker.init(elem, options);
        elem.addEventListener('change', (e) => {
            this.props.onChange(this.id, e.target.value)
        });
    }
    componentWillUnmount() {
        let elem = document.getElementById(this.id);
        let instance = M.Datepicker.init(elem, {});
        instance.destroy();
    }

    handleChange(e) {

    };

    render() {
        return (
            <div class="row">
                <form>
                    <div  class="input-field col s6">
                        <input id={this.id} key={this.key} type="text" class="datepicker"  />
                        <label>{this.label}
                        </label>
                    </div>
                </form>
            </div>
        )
    }
};

class Radio extends React.Component {
    constructor (props) {
        super(props);
        this.label = this.props.label;
        this.key = this.props.key;
        this.id = this.props.id;
        this.fistOption = this.props.first;
        this.secondOption = this.props.second;
        this.handleChange = this.handleChange.bind(this);
        this.state = ({
            span1: 'normal',
            span2: 'normal'
        })
    }
    componentDidMount() {

    }
    handleChange(e) {
        this.props.onChange(this.id, e.target.value);
        this.setState({
            span1: e.target.value === this.fistOption ? "bolder" : "normal",
            span2: e.target.value === this.secondOption ? "bolder" : "normal",
        });
    }
    render() {
        return (
            <div class="row">
                <label>{this.label}</label>
                 <form key={this.key}>
                    <p>
                    <label>
                        <input name="group1" type="radio" value={this.fistOption} onClick={this.handleChange} />
                        <span style={{"font-weight": this.state.span1}} >{this.fistOption}</span>
                    </label>
                    </p>
                    <p>
                    <label>
                        <input name="group1" type="radio" value={this.secondOption} onClick={this.handleChange} />
                        <span style={{"font-weight": this.state.span2}} >{this.secondOption}</span>
                    </label>
                    </p>
                </form>
            </div>
        )
    }
};

class CheckBox extends React.Component {
    constructor (props) {
        super(props);
        this.label = this.props.label;
        this.id = this.props.id;
        this.key = this.props.key;
        this.handleChange = this.handleChange.bind(this);
        this.value = this.props.value;
        this.state = ({
            value: this.value,
            span: "normal"
        })
    }
    componentDidMount() {
    }
    handleChange(e) {
        let status = e.target.value;
        let val;
        switch (status) {
            case "yes":
                val = "no";
                break;
            default:
                val = "yes"
        }
        this.props.onChange(this.id, val);
        this.setState({
            value: val,
            span:  (val == "no" ? "normal" : "bolder")
        });
    }
    render() {
        return (
            <div class="row">
                <p>
                    <label>
                        <input id={this.id} key={this.key} type="checkbox"  class="filled-in" checked={this.state.value == "yes" ? "checked" : ""} value={this.state.value} onChange={this.handleChange} />
                        <span style={{"font-weight": this.state.span}} >{this.label}</span>
                    </label>
                </p>
            </div>
        )
    }
}

class Select extends React.Component {
    constructor (props) {
        super(props);
        this.handleChange = this.handleChange.bind(this);
        this.state =  {value: ''};
    };
    componentDidMount(){
        let elem = document.getElementById(this.props.id);
        let instance = M.FormSelect.init(elem, {});
    };
    componentWillUnmount(){
    }
    handleChange(e) {
        this.props.onChange(this.props.id, e.target.value);
        this.setState({
            value: e.target.value
        });
    }
    render () {
        function generateOptions (arr) {
            if (arr != null) {
                return arr.map((el) =>
                    <option key={el} value={el}>{el}</option>
                );
            } else {
                return <option></option>
            } 
        };
        let options = generateOptions(this.props.value); 
        let specialClass;
        if (this.props.purpose === "flat") {
            //specialClass = "browser-default";
        } 
        return (
            <div class="row">
                <div class="input-field col s6">
                    {<select class={specialClass} key={this.props.key} id={this.props.id} onChange={this.handleChange} value={this.state.value} >
                        <option></option>
                        {options}
                    </select>}
                    <label>{this.props.label}</label>
                </div>
            </div>
        );
    };
};

class DocFieldsHandler extends React.Component {
    constructor (props) {
        super(props);
        this.handleChildChange = this.handleChildChange.bind(this);
        this.handleLiterChange = this.handleLiterChange.bind(this);
        this.state = {
            CurrentStatusDate: '',
            NextStatusEstimatedDate: '',
            ClientName: '',
            RemainsOnSale: 'no',
            DealType: '',
            SelectLiter: '',
            SelectFlat: '',
            DocStatus: '',
            SelectManager: '',
            PayMethod: '',
            ActualCost: '',
            LegalCost: '',
            LegalServiceCost: '',
            LegalServiceNoPayment: '',
            RealEstateAgency: '',
            EstateAgent: '',
            Comment: ''
        };
    };
    // принимает изменения от всех полей 
    handleChildChange(field, value) {
        if (this.state[field] === value) {
            return;
        };
        this.setState({
            [field]: value,
        });
        //console.log(`поле: ${field} значение: ${value} `)
    };
    // отакое дерьмо нужно, чтобы материалайзовый селект рендерился корректно 
    handleLiterChange(field, value) {
        this.setState({
            [field]: '',
        });
        setTimeout(() => {
            this.setState({
                [field]: value,
            });
        }, 10);
    }

    render () {
        return (
            <React.Fragment>
                <Select
                    id = "DocStatus"
                    key = "DocStatus"
                    label = "Текущий статус документа:"
                    value = {getSingleCol("doc_statuses", "utilitySheet")}
                    onChange={this.handleChildChange}
                />
                <DatePicker
                    id = "CurrentStatusDate"
                    key = "CurrentStatusDate"
                    label = "Дата текущего статуса:"
                    value = {this.state.CurrentStatusDate}
                    onChange={this.handleChildChange}
                />
                <DatePicker
                    id = "NextStatusEstimatedDate"
                    key = "NextStatusEstimatedDate"
                    label = "Предполагаемая дата следующего статуса:"
                    value = {this.state.NextStatusEstimatedDate}
                    onChange={this.handleChildChange}
                />
                <Select
                    id = "SelectLiter"
                    key = "SelectLiter"
                    label = "Литер:"
                    value = {getSingleCol("liters", "utilitySheet")}
                    onChange={this.handleLiterChange}
                />{this.state.SelectLiter != '' &&
                <Select
                    id = "SelectFlat"
                    key = "SelectFlat"
                    label = "Номер квартиры:"
                    value = {getFlatsInStock(this.state.SelectLiter,'flats_in_sale', 'flats_in_sale_liter', "utilitySheet")}
                    purpose = "flat"
                    onChange={this.handleChildChange}
                />
                }
                <TextField
                    id = "ClientName"
                    key = "ClientName"
                    label = "ФИО клиента:"
                    value = {this.state.ClientName}
                    onChange={this.handleChildChange}
                />
                <Select
                    id = "SelectManager"
                    label = "Менеджер:"
                    key = "SelectManager"
                    value = {getSingleCol("managers", "utilitySheet")}
                    onChange={this.handleChildChange}
                />
                <CheckBox
                    id = "RemainsOnSale"
                    key = "RemainsOnSale"
                    label = "остается в продаже от физ. лица"
                    value = {this.state.RemainsOnSale}
                    onChange={this.handleChildChange}
                />
                <Radio
                    id = "DealType"
                    key = "DealType"
                    label = "Тип сделки:"
                    first='Л'
                    second='АН'
                    value = {this.state.DealType}
                    onChange={this.handleChildChange}
                />
                <Select
                    id = "PayMethod"
                    label = "Способ оплаты:"
                    key = "PayMethod"
                    value = {getSingleCol("pay_method", "utilitySheet")}
                    onChange={this.handleChildChange}
                />
                <TextField
                    id = "ActualCost"
                    label = "Стоимость для расчета комиссии:"
                    key = "ActualCost"
                    value = {this.state.ActualCost}
                    onChange={this.handleChildChange}
                />
                <TextField
                    id = "LegalCost"
                    label = "Стоимость по ДДУ:"
                    key = "LegalCost"
                    value = {this.state.LegalCost}
                    onChange={this.handleChildChange}
                />
                <TextField
                    id = "LegalServiceCost"
                    label = "Оплата юр. услуг:"
                    key = "LegalServiceCost"
                    value = {this.state.LegalServiceCost}
                    onChange={this.handleChildChange}
                />
                <Select
                    id = "LegalServiceNoPayment"
                    label = "Юр. услуги без оплаты:"
                    key = "LegalServiceNoPayment"
                    value = {getSingleCol("legal_service_no_payment", "utilitySheet")}
                    onChange={this.handleChildChange}
                />
                <TextField
                    id = "RealEstateAgency"
                    label = "Агентство недвижимости:"
                    key = "RealEstateAgency"
                    value = {this.state.RealEstateAgency}
                    onChange={this.handleChildChange}
                />
                <TextField
                    id = "EstateAgent"
                    label = "Сотрудник агентства:"
                    key = "EstateAgent"
                    value = {this.state.EstateAgent}
                    onChange={this.handleChildChange}
                />
                <TextField
                    id = "Comment"
                    label = "Комментарий к документу:"
                    key = "Comment"
                    purpose = "area"
                    value = {this.state.Comment}
                    onChange={this.handleChildChange}
                />
            </React.Fragment>
        )
    }
};
</script>